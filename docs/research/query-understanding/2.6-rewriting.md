# Research: 2.6 Query Rewriting & Expansion

## The Problem
Users type imperfect queries. Rewriting and expansion bridge the gap between query and corpus.

---

## Query Expansion

### What It Is
Adding terms to the original query to improve recall.

### Types of Expansion

#### 1. Synonym Expansion
```
"couch" → "couch OR sofa OR loveseat"
```

**Sources:**
- Curated synonym lists (highest quality)
- WordNet / thesauri (general purpose)
- Word embeddings (automated)
- Query logs (real user behavior)

**Gotchas:**
- Context matters: "Python" → "snake"? (Only in pet context)
- One-way synonyms: "NYC" → "New York City", but not always reverse
- Domain-specific: "bug" → "insect" or "software defect"?

#### 2. Stemming/Lemmatization
```
"running shoes" → "run shoe" (stems)
"running shoes" → "run shoe" (lemmas)
```

**Stemming:** Crude truncation (Porter, Snowball)
- "running" → "run"
- "better" → "better" (fails)

**Lemmatization:** Dictionary-based
- "running" → "run"
- "better" → "good"

**Trade-off:** Stemming is faster but less accurate

#### 3. Hypernym/Hyponym Expansion
```
Hypernym: "iPhone" → "smartphone" (broader)
Hyponym: "smartphone" → "iPhone", "Galaxy", "Pixel" (narrower)
```

**Use cases:**
- Fallback: If "iPhone 15 Pro Max" has no results, try "iPhone"
- Category pages: "phones" → show all phone brands

#### 4. Related Term Expansion
```
"camera" → "camera lens tripod memory card"
```

**Sources:**
- Query co-occurrence (users who search X also search Y)
- Click co-occurrence (users who click X also click Y)
- Product relationships (frequently bought together)

---

## Query Rewriting

### What It Is
Transforming the query into a different form (often structured).

### Types of Rewriting

#### 1. Structured Rewriting
```
"cheap laptop" → {
  category: "laptop",
  price: {max: 500}
}

"Nike shoes size 10" → {
  brand: "Nike",
  category: "shoes",
  size: "10"
}
```

**Benefits:**
- Use filters instead of text match
- Exact attribute matching
- Better precision

#### 2. Spell Correction Rewriting
```
"runing shoes" → "running shoes"
"iphoen" → "iPhone"
```

**Approaches:**
- Edit distance (Levenshtein)
- Phonetic matching (Soundex)
- ML models (seq2seq)

#### 3. Normalization Rewriting
```
"men's" → "mens"
"MacBook" → "macbook"
"$50" → price:50
```

#### 4. Semantic Rewriting (LLM-powered)
```
"I need something to sit on in my living room" → "living room furniture sofa chair"
"laptop for my kid to do homework" → "budget laptop student chromebook"
```

**Modern approach:** Use LLM to rewrite query into search-friendly form.

---

## Techniques

### Query-Time vs Index-Time

| Approach | Query-Time Expansion | Index-Time Expansion |
|----------|---------------------|----------------------|
| Where | Modify query | Modify index |
| Example | "couch" → "couch OR sofa" | Index "sofa" under "couch" token |
| Pros | Flexible, no reindex | Faster queries |
| Cons | Slower queries | Index bloat, less flexible |

### Query Log Mining

**Idea:** Learn from user behavior.

```
User searches "ipone"
User reformulates to "iphone"
System learns: "ipone" → "iphone"
```

**Metrics:**
- Session-based reformulation
- Click-through on reformulated query
- Successful session after rewrite

### Embedding-Based Expansion

**Idea:** Find semantically similar terms via embeddings.

```python
similar_to("couch") = [
  ("sofa", 0.95),
  ("loveseat", 0.88),
  ("sectional", 0.82),
  ("chair", 0.65),  # Maybe too far?
]
```

**Threshold:** Only expand if similarity > 0.8

---

## Real-World Examples

### Example 1: Google "Did you mean?"
```
Query: "receipe for chocolate cake"
Google shows: "Did you mean: recipe for chocolate cake"
```

**Key:** Only suggest, don't auto-correct (user might have meant what they typed)

### Example 2: Amazon Category Mapping
```
Query: "laptop"
Expansion: category:Computers > Laptops
          + brand boosts
          + recent search personalization
```

### Example 3: Spotify
```
Query: "that song that goes da da da"
Rewrite: Use audio matching + lyric search
Result: Suggest songs based on melody pattern
```

### Example 4: Enterprise Search
```
Query: "Q3 report"
Expansion: "Q3 report" OR "third quarter report" OR "quarterly report 2024 Q3"
Time filter: last 90 days
```

---

## Trade-offs

### Precision vs Recall

| Strategy | Precision | Recall | When to Use |
|----------|-----------|--------|-------------|
| No expansion | High | Low | Very specific queries |
| Light expansion | High | Medium | Default |
| Heavy expansion | Low | High | Zero result fallback |

### When to Expand

| Condition | Expansion Level |
|-----------|-----------------|
| Many results | Don't expand (already good recall) |
| Few results | Light expansion |
| Zero results | Heavy expansion + fallback |
| Navigational query | Don't expand (user wants exact) |
| Transactional query | Moderate expansion |

---

## Common Mistakes

### Mistake 1: Over-Expansion
```
Query: "Nike"
Bad expansion: "Nike OR Adidas OR Puma OR Reebok"
```
User said Nike, they want Nike!

### Mistake 2: Context-Free Expansion
```
Query: "Python course"
Bad expansion: "Python OR snake course"
```
Context is programming, not reptiles.

### Mistake 3: Symmetric Expansion
```
"dog" → "puppy" (OK: puppy is a dog)
"puppy" → "dog" (Maybe not: user specifically wants young dogs)
```

### Mistake 4: Expanding Filters
```
Query: "shoes under $50"
Bad expansion: "shoes under $50 OR shoes under $100"
```
User specified a budget constraint!

---

## Best Practices

### 1. Tiered Expansion
```
1. First try: Exact match
2. If low results: Add synonyms
3. If zero results: Semantic expansion
4. Last resort: Category fallback
```

### 2. Maintain User Intent
- Don't expand filters/constraints
- Don't expand negations
- Preserve brand names

### 3. Measure Impact
- A/B test expansion strategies
- Track zero-result rate improvement
- Watch for precision drops (irrelevant results)

### 4. Use Feedback Loops
- Log which expansions led to clicks
- Demote expansions that don't help
- Learn from reformulations

---

## Key Takeaways

1. **Expansion increases recall** but can hurt precision
2. **Rewriting converts to structured** — better for filtering
3. **Context matters** — "Python" means different things
4. **Don't over-expand** — respect user's specificity
5. **Tiered approach** — expand more as results decrease
6. **Measure everything** — expansion can easily go wrong
